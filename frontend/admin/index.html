<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="https://glitch.com/favicon.ico" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css"
    />
    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables library -->
    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css"
    />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="../js/api.js"></script>
    <title>Página do Administrador</title>
  </head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: #f5f5f5;
      width: 100%;
      min-height: 100vh;
      color: #333;
    }
    .main {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 10px;
      width: 100%;
    }
    .hide {
      display: none;
    }
    .tabelaUsuario,
    .tabelaRodada,
    .tabelaPontuacao {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
      gap: 10px;
      text-align: center;
      overflow-x: auto;
    }
    #tabelaUsuario_wrapper,
    #tabelaRodada_wrapper,
    #tabelaPontuacao_wrapper {
      width: 100%;
    }
    .error {
      color: red;
    }
    .success {
      color: green;
    }

    .btns {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    @media screen and (max-width: 768px) {
      .btns {
        flex-direction: column;
      }
    }
  </style>

  <body class="hide">
    <main class="main">
      <h1>Painel de Administração</h1>
      <div class="tabelaUsuario">
        <h3>Painel dos usuarios</h3>
        <table id="tabelaUsuario">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Crédito</th>
              <th>Chave Pix</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="tabelaRodada">
        <h3>Painel da rodada atual</h3>
        <table id="tabelaRodada">
          <thead>
            <tr>
              <th>Jogo1</th>
              <th>Jogo2</th>
              <th>Jogo3</th>
              <th>Jogo4</th>
              <th>Jogo5</th>
              <th>Jogo6</th>
              <th>Jogo7</th>
              <th>Jogo8</th>
              <th>Jogo9</th>
              <th>Jogo10</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="tabelaPontuacao">
        <h3>Painel das pontuações</h3>
        <table id="tabelaPontuacao">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Nome</th>
              <th>Jogo1</th>
              <th>Jogo2</th>
              <th>Jogo3</th>
              <th>Jogo4</th>
              <th>Jogo5</th>
              <th>Jogo6</th>
              <th>Jogo7</th>
              <th>Jogo8</th>
              <th>Jogo9</th>
              <th>Jogo10</th>
              <th>Pontuação Final</th>
              <th>Horário</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>
    <script src="../js/verificaAdm.js"></script>

    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      const tabelaUsuario = document.getElementById("tabelaUsuario"),
        tbodyTabelaUsuario = tabelaUsuario.querySelector("tbody"),
        tabelaRodada = document.getElementById("tabelaRodada"),
        tbodyTabelaRodada = tabelaRodada.querySelector("tbody"),
        tabelaPontuacao = document.getElementById("tabelaPontuacao"),
        tbodyTabelaPontuacao = tabelaPontuacao.querySelector("tbody");

      let rodadaId = "";

      const getRodada = async () => {
        const response = await api.get("/rodada/listarUltima");
        rodadaId = response.data.rodada.id;
        return response.data.rodada;
      };

      const getUsuarios = async () => {
        const response = await api.get("/usuario/listar");
        return response.data.usuarios;
      };

      const getRespostas = async () => {
        const response = await api.get("/resposta/listarPorRodada/" + rodadaId);
        return response.data.respostas;
      };

      const showRespostas = async () => {
        const rodada = await getRodada();
        const respostas = await getRespostas();

        tbodyTabelaPontuacao.innerHTML = "";

        const pontuacaoArray = respostas.map((resp) => {
          let pontuacaoFinal = 0;
          console.log(resp);
          const pontuacao = {
            nome: resp.usuario.nomeCompleto,
            data: resp.criado,
            pontuacaoFinal: 0,
          };

          for (let i = 1; i <= 10; i++) {
            const key = `jogo${i}`;
            const jogo = rodada[key];
            const resposta = resp[key];
            const acerto = resposta == jogo;
            pontuacaoFinal += acerto ? 1 : 0;
            pontuacao[key] = acerto
              ? {
                  acerto,
                  icon: '<i class="fas fa-check success"></i>',
                }
              : {
                  acerto,
                  icon: '<i class="fas fa-times error"></i>',
                };
          }
          pontuacao.pontuacaoFinal = pontuacaoFinal;
          return pontuacao;
        });
        pontuacaoArray.sort((a, b) => {
          if (a.pontuacaoFinal > b.pontuacaoFinal) return -1;
          if (a.pontuacaoFinal < b.pontuacaoFinal) return 1;
          return 0;
        });
        console.log(pontuacaoArray);
        pontuacaoArray.forEach((resp, index) => {
          const i = index + 1;
          const data = new Date(resp.data).toLocaleString();
          const tr = document.createElement("tr");
          tr.innerHTML = `
    <td>${i}</td>
    <td>${resp.nome}</td>
    <td>${resp.jogo1.icon}</td>
    <td>${resp.jogo2.icon}</td>
    <td>${resp.jogo3.icon}</td>
    <td>${resp.jogo4.icon}</td>
    <td>${resp.jogo5.icon}</td>
    <td>${resp.jogo6.icon}</td>
    <td>${resp.jogo7.icon}</td>
    <td>${resp.jogo8.icon}</td>
    <td>${resp.jogo9.icon}</td>
    <td>${resp.jogo10.icon}</td>
    <td>${resp.pontuacaoFinal}</td>
    <td>${data}</td>
    `;
          tbodyTabelaPontuacao.appendChild(tr);
        });
        $(document).ready(() => {
          $("#tabelaPontuacao").DataTable({
            responsive: true,
            fixedHeader: true,
            language: {
              url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
            },
          });
        });
        // document.querySelector(".c-loader").classList.add("hide");
        // document.querySelector(".tabelaPontuacao").classList.remove("hide");
      };

      const showRodadas = async () => {
        const rodada = await getRodada();
        rodadaId = rodada.id;
        tbodyTabelaRodada.innerHTML = "";
        const tr = document.createElement("tr");
        tr.innerHTML = `

            <td class="jogoRodada">${rodada.jogo1} </td>
            <td class="jogoRodada">${rodada.jogo2}</td>
            <td class="jogoRodada">${rodada.jogo3}</td>
            <td class="jogoRodada">${rodada.jogo4}</td>
            <td class="jogoRodada">${rodada.jogo5}</td>
            <td class="jogoRodada">${rodada.jogo6}</td>
            <td class="jogoRodada">${rodada.jogo7}</td>
            <td class="jogoRodada">${rodada.jogo8}</td>
            <td class="jogoRodada">${rodada.jogo9}</td>
            <td class="jogoRodada">${rodada.jogo10}</td>
            <td id="actionRodada"><button class="btn btn-primary" id="btnEditRodada" onclick="hcEditarRodada()">Editar rodada</button></td>
          `;
        tbodyTabelaRodada.appendChild(tr);
        $(document).ready(() => {
          $("#tabelaRodada").DataTable({
            responsive: true,
            fixedHeader: true,
            language: {
              url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
            },
          });
        });
      };

      const showUsuarios = async () => {
        const usuarios = await getUsuarios();
        tbodyTabelaUsuario.innerHTML = "";
        usuarios.forEach((usuario) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${usuario.nomeCompleto}</td>
            <td>${usuario.creditos}</td>
            <td>${usuario.chavePix}</td>
            <td>
              <button class="btn btn-primary" onclick="excluirUsuario('${usuario.id}')">Excluir Usuário</button>
            </td>
            <td>
              <button class="btn btn-primary" onclick="editarCredito('${usuario.id}')">Editar Crédito</button>
            </td>
          `;
          tbodyTabelaUsuario.appendChild(tr);
        });
        $(document).ready(() => {
          $("#tabelaUsuario").DataTable({
            responsive: true,
            fixedHeader: true,
            language: {
              url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
            },
          });
        });
      };

      const hcEditarRodada = async () => {
        const jogosElement = document.querySelectorAll(".jogoRodada");
        const actionRodada = document.getElementById("actionRodada");
        jogosElement.forEach((jogo) => {
          jogo.setAttribute("contenteditable", "true");
        });
        // botao cancelar
        const btnCancel = document.createElement("button");
        btnCancel.setAttribute("onclick", "cancelarEdicaoRodada()");
        btnCancel.innerHTML = "Cancelar";
        btnCancel.classList.add("btn");
        btnCancel.classList.add("btn-primary");

        actionRodada.appendChild(btnCancel);
        // fim botao cancelar
        // botao editar
        const btnEditRodada = document.getElementById("btnEditRodada");
        btnEditRodada.innerHTML = "Salvar";
        btnEditRodada.setAttribute("onclick", "salvarRodadaEditada()");
        // fim botao editar
      };

      const cancelarEdicaoRodada = async () => {
        await showRodadas();
      };

      const salvarRodadaEditada = async () => {
        const jogosElement = document.querySelectorAll(".jogoRodada");
        const jogos = {};
        jogosElement.forEach((jogo, index) => {
          jogos[`jogo${index + 1}`] = jogo.innerHTML;
        });

        // Enviar a requisição para atualizar o crédito do usuário
        const res = await api.put("/rodada/atualizar/jogos/" + rodadaId, jogos);
        console.log(res);
        if (res.status === 200) {
          alert("Rodada atualizada com sucesso!");
          await main();
        }
      };

      const editarCredito = (userId) => {
        const creditos = prompt("Digite o novo valor de crédito:");
        if (creditos !== null) {
          // Enviar a requisição para atualizar o crédito do usuário
          api
            .put("/usuario/creditos/" + userId, { creditos })
            .then((response) => {
              console.log("Crédito atualizado com sucesso!");
              window.location.reload();
            })
            .catch((error) => {
              console.error("Erro ao atualizar o crédito:", error);
            });
        }
      };

      const excluirUsuario = (userId) => {
        if (confirm("Tem certeza que deseja excluir esse usuário?")) {
          // Enviar a requisição para excluir o usuário
          api
            .delete("/usuario/deletar/" + userId)
            .then((response) => {
              console.log("Usuário excluído com sucesso!");
              window.location.reload();
            })
            .catch((error) => {
              console.error("Erro ao excluir o usuário:", error);
            });
        }
      };
      const main = async () => {
        await showRodadas();
        await Promise.all([showUsuarios(), showRespostas()]);
      };
      main();
    </script>
  </body>
</html>
