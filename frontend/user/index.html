<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://glitch.com/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Página do Usuário</title>
    <link rel="stylesheet" href="style.css" />

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables library -->
    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css"
    />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="../js/api.js"></script>
  </head>

  <body class="hide">
    <main>
      <img class="bg" src="../assets/bg-bet-legal.jpg" alt="" />

      <div class="container">
        <div class="carrousselContainer">
          <div class="w-100 align-items-center justify-content-center">
            <div
              id="carouselExampleIndicators"
              class="carousel slide"
              data-ride="carousel"
            >
              <ol class="carousel-indicators">
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="0"
                  class="active"
                ></li>
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="1"
                ></li>
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="2"
                ></li>
              </ol>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel1.jpg"
                    alt="Primeiro Slide"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel2.jpg"
                    alt="Segundo Slide"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel3.jpg"
                    alt="Terceiro Slide"
                  />
                </div>
              </div>
              <a
                class="carousel-control-prev"
                href="#carouselExampleIndicators"
                role="button"
                data-slide="prev"
              >
                <span
                  class="carousel-control-prev-icon"
                  aria-hidden="true"
                ></span>
                <span class="sr-only">Anterior</span>
              </a>
              <a
                class="carousel-control-next"
                href="#carouselExampleIndicators"
                role="button"
                data-slide="next"
              >
                <span
                  class="carousel-control-next-icon"
                  aria-hidden="true"
                ></span>
                <span class="sr-only">Próximo</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="container infos">
        <h1 class="username"></h1>
        <p class="saldo"></p>
        <a type="button" href="/" class="btn play-btn">Jogar agora</a>

        <h2>Inserir Créditos</h2>
        <button class="btn btn-primary btn-cred" onclick="mostrarOpcoes()">
          Inserir Créditos
        </button>

        <div id="opcoes" class="hide">
          <button class="btn btn-primary btn-cred" onclick="inserirCredito(10)">
            R$ 10.00
          </button>
          <button class="btn btn-primary btn-cred" onclick="inserirCredito(50)">
            R$ 50.00
          </button>
          <button
            class="btn btn-primary btn-cred"
            onclick="inserirCredito(100)"
          >
            R$ 100.00
          </button>
        </div>

        <div class="sacar">
          <h2>Sacar Saldo</h2>
          <button class="btn btn-primary btn-cred" onclick="sacarSaldo()">
            Sacar Saldo
          </button>
        </div>

        <div class="tabelaPontuacao">
          <h3>Painel das pontuações</h3>
          <table id="tabelaPontuacao">
            <thead>
              <tr>
                <th>Jogo1</th>
                <th>Jogo2</th>
                <th>Jogo3</th>
                <th>Jogo4</th>
                <th>Jogo5</th>
                <th>Jogo6</th>
                <th>Jogo7</th>
                <th>Jogo8</th>
                <th>Jogo9</th>
                <th>Jogo10</th>
                <th>Pontuação Final</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>

  <script>
    const username = document.querySelector(".username");
    const saldo = document.querySelector(".saldo");
    const tbodyTabelaPontuacao = document.querySelector(
      "#tabelaPontuacao tbody"
    );
    //utils
    const inserirCredito = (valor) => {
      // Aqui você pode adicionar a lógica para processar a inserção de crédito
      // Pode ser uma requisição AJAX para o servidor ou qualquer outra ação necessária
      console.log("Inserir crédito de R$" + valor);
      // Redirecionar o usuário para a página desejada após a inserção de crédito
    };

    const sacarSaldo = () => {
      // Aqui você pode adicionar a lógica para processar o saque de saldo
      // Pode ser uma requisição AJAX para o servidor ou qualquer outra ação necessária
      console.log("Sacar saldo");
      // Redirecionar o usuário para a página desejada após o saque de saldo
    };
    const getCookies = () => {
      const cookies = document.cookie.split(";");
      return cookies;
    };

    const mostrarOpcoes = () => {
      const opcoesDiv = document.getElementById("opcoes");
      opcoesDiv.classList.toggle("hide");
    };

    const getIdUserCookie = () => {
      const cookies = getCookies();
      const idUser = cookies.find((item) => item.includes("id-user"));
      if (!idUser) return { idFormatado: null, idUser: null };
      const idFormatado = idUser.substring(9);
      return { idFormatado, idUser };
    };

    const verificaLogin = () => {
      const { idUser } = getIdUserCookie();
      const isLogged = idUser ? true : false;
      if (!isLogged) {
        window.location.href = "/login";
        return false;
      }
      return isLogged;
    };

    const getUsuario = async () => {
      verificaLogin();
      const { idFormatado: id } = getIdUserCookie();
      const response = await api.get("/usuario/buscar/" + id);
      return response.data.usuario;
    };

    const showUsuario = async () => {
      const usuario = await getUsuario();
      username.innerHTML = "Bem-vindo, " + usuario.nomeCompleto + "!";
      saldo.innerHTML = "Seu saldo de créditos: " + usuario.creditos;
    };

    const getRespostas = async () => {
      const usuario = await getUsuario();
      console.log(usuario);
      return usuario;
    };

    const getRodada = async () => {
      const response = await api.get("/rodada/listarUltima");
      return response.data.rodada;
    };

    const showRespostas = async () => {
      const { Respostas: respostas } = await getRespostas();
      const rodada = await getRodada();

      tbodyTabelaPontuacao.innerHTML = "";

      console.log(respostas);

      respostas.forEach((resp, index) => {
        const tr = document.createElement("tr");
        let pontuacaoFinal = 0;
        const pontuacao = {};

        for (let i = 1; i <= 10; i++) {
          const key = `jogo${i}`;
          const jogo = rodada[key];
          const resposta = resp[key];
          const acerto = resposta == jogo;
          pontuacaoFinal += acerto ? 1 : 0;
          pontuacao[key] = acerto
            ? {
                acerto: true,
                icon: '<i class="fas fa-check success"></i>',
              }
            : {
                acerto: false,
                icon: '<i class="fas fa-times error"></i>',
              };
          tr.innerHTML += `
                <td class="jogoResposta">${pontuacao[key].icon} </td>
              `;
        }
        tr.innerHTML += `
                <td class="jogoResposta">${pontuacaoFinal} </td>
              `;

        tbodyTabelaPontuacao.appendChild(tr);
      });
      $(document).ready(() => {
        $("#tabelaPontuacao").DataTable({
          responsive: true,
          fixedHeader: true,
          language: {
            url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
          },
        });
      });
    };

    const main = async () => {
      const isLogged = verificaLogin();
      if (!isLogged) {
        window.location.href = "/login";
        return;
      }
      document.querySelector("body").classList.remove("hide");
      await Promise.all([showUsuario(), showRespostas()]);
    };
    main();
  </script>
</html>
