<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="https://glitch.com/favicon.ico" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Página do Usuário</title>
    <link rel="stylesheet" href="style.css" />

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables library -->
    <link
      href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css"
    />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="../js/api.js"></script>
  </head>

  <body class="hide">
    <main>
      <img class="bg" src="../assets/bg-bet-legal.jpg" alt="" />

      <div class="container">
        <div class="carrousselContainer">
          <div class="w-100 align-items-center justify-content-center">
            <div
              id="carouselExampleIndicators"
              class="carousel slide"
              data-ride="carousel"
            >
              <ol class="carousel-indicators">
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="0"
                  class="active"
                ></li>
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="1"
                ></li>
                <li
                  data-target="#carouselExampleIndicators"
                  data-slide-to="2"
                ></li>
              </ol>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel1.jpg"
                    alt="Primeiro Slide"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel2.jpg"
                    alt="Segundo Slide"
                  />
                </div>
                <div class="carousel-item">
                  <img
                    class="d-block img-carrousel rounded w-100"
                    src="../assets/carrousel3.jpg"
                    alt="Terceiro Slide"
                  />
                </div>
              </div>
              <a
                class="carousel-control-prev"
                href="#carouselExampleIndicators"
                role="button"
                data-slide="prev"
              >
                <span
                  class="carousel-control-prev-icon"
                  aria-hidden="true"
                ></span>
                <span class="sr-only">Anterior</span>
              </a>
              <a
                class="carousel-control-next"
                href="#carouselExampleIndicators"
                role="button"
                data-slide="next"
              >
                <span
                  class="carousel-control-next-icon"
                  aria-hidden="true"
                ></span>
                <span class="sr-only">Próximo</span>
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="container infos">
        <h1 class="username"></h1>
        <p class="saldo"></p>
        <p style="font-weight: 700; color: red">
          Ao inserir créditos, informe seu nome de usuário, apelido e e-mail na
          área pix do seu banco
        </p>
        <a type="button" href="/" class="btn play-btn">Jogar agora</a>

        <h2>Inserir Créditos</h2>
        <button class="btn btn-primary btn-cred" onclick="mostrarOpcoes()">
          Inserir Créditos
        </button>

        <div id="opcoes" class="hide">
          <button
            data-bs-toggle="modal"
            data-bs-target="#modalId"
            class="btn btn-primary btn-cred"
            onclick="inserirCredito(10)"
          >
            R$ 10.00
          </button>
          <button
            data-bs-toggle="modal"
            data-bs-target="#modalId"
            class="btn btn-primary btn-cred"
            onclick="inserirCredito(50)"
          >
            R$ 50.00
          </button>
          <button
            data-bs-toggle="modal"
            data-bs-target="#modalId"
            class="btn btn-primary btn-cred"
            onclick="inserirCredito(100)"
          >
            R$ 100.00
          </button>
        </div>

        <div class="sacar">
          <h2>Sacar Saldo</h2>
          <button
            id="btnSacar"
            class="btn btn-primary btn-cred"
            onclick="sacarSaldo()"
          >
            Sacar Saldo
          </button>
        </div>
        <div class="c-loader">
          <div class="custom-loade"></div>
        </div>
        <div class="tabelaPontuacao">
          <h3>Painel das pontuações</h3>
          <table id="tabelaPontuacao">
            <thead>
              <tr>
                <th>Data</th>
                <th>Jogo1</th>
                <th>Jogo2</th>
                <th>Jogo3</th>
                <th>Jogo4</th>
                <th>Jogo5</th>
                <th>Jogo6</th>
                <th>Jogo7</th>
                <th>Jogo8</th>
                <th>Jogo9</th>
                <th>Jogo10</th>
                <th>Pontuação Final</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Modal Body -->
    <!-- if you want to close by clicking outside the modal, delete the last endpoint:data-bs-backdrop and data-bs-keyboard -->
    <div
      class="modal fade"
      id="modalId"
      tabindex="-1"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      role="dialog"
      aria-labelledby="modalTitleId"
      aria-hidden="true"
    >
      <div
        class="modal-dialog modal-dialog-scrollable modal-dialog-centered modal-sm"
        role="document"
      >
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitleId">
              PIX: Código Copia e Cola
            </h5>
            <button
              type="button"
              class="btn btn-close btn-danger"
              data-bs-dismiss="modal"
              aria-label="Close"
            >
              <i class="fa fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="custom-loader"></div>
            <code id="codePixContainer" class="hide">
              <div class="copyIcon">
                <i class="fa fa-copy"></i>
              </div>
              <kbd id="codePix"></kbd>
            </code>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary">Save</button>
          </div>
        </div>
      </div>
    </div>

    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/umd/simple-datatables.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"
    ></script>
  </body>

  <script>
    const username = document.querySelector(".username");
    const saldo = document.querySelector(".saldo");
    const tbodyTabelaPontuacao = document.querySelector(
      "#tabelaPontuacao tbody"
    );
    let usuario = {};

    const copyPix = () => {
      const codePix = document.getElementById("codePix");
      const codePixText = codePix.innerText;
      navigator.clipboard.writeText(codePixText);
      alert("Código copiado com sucesso!");
    };
    //utils
    const inserirCredito = (valor) => {
      // Aqui você pode adicionar a lógica para processar a inserção de crédito
      // Pode ser uma requisição AJAX para o servidor ou qualquer outra ação necessária
      const codePixContainer = document.getElementById("codePixContainer");
      const loader = document.querySelector(".custom-loader");
      codePixContainer.classList.remove("hide");
      loader.classList.add("hide");
      codePixContainer.addEventListener("click", copyPix);
      const codigoPixElement = document.getElementById("codePix");
      if (valor == 10) {
        codigoPixElement.innerHTML = `00020126580014BR.GOV.BCB.PIX013655f384af-8aa0-431a-9b56-7655ebc1919c520400005303986540510.005802BR5925MARCIO MARQUES DE SOUZA 06009SAO PAULO61080540900062250521z1qv6VVSa8bJmGZ12zebu6304D4BF`;
        return;
      }
      if (valor == 50) {
        codigoPixElement.innerHTML = `00020126580014BR.GOV.BCB.PIX013655f384af-8aa0-431a-9b56-7655ebc1919c520400005303986540550.005802BR5925MARCIOMARQUES DE SOUZA 06009SAO PAULO61080540900062250521og3gJmHjP0gXPJt12zebu630453B0`;
        return;
      }
      if (valor == 100) {
        codigoPixElement.innerHTML = `00020126580014BR.GOV.BCB.PIX013655f384af-8aa0-431a-9b56-7655ebc1919c5204000053039865406100.005802BR5925MARCIO MARQUES DE SOUZA 06009SAO PAULO61080540900062250521qkQ3BZmiaWqbnCj12zebu63047CA3`;
        return;
      }
    };

    const sacarSaldo = () => {
      // Aqui você pode adicionar a lógica para processar o saque de saldo
      // Pode ser uma requisição AJAX para o servidor ou qualquer outra ação necessária
      const valor = window.prompt("Digite o valor que deseja sacar");
      if (!valor) return;
      if (valor > usuario.creditos) return alert("Saldo insuficiente");
      const link = getLinkWhatsapp(usuario, valor);
      window.open(link, "_blank");
      // Redirecionar o usuário para a página desejada após o saque de saldo
    };
    const getCookies = () => {
      const cookies = document.cookie.split(";");
      return cookies;
    };

    const mostrarOpcoes = () => {
      const opcoesDiv = document.getElementById("opcoes");
      opcoesDiv.classList.toggle("hide");
    };

    const getIdUserCookie = () => {
      const cookies = getCookies();
      const idUser = cookies.find((item) => item.includes("id-user"));
      if (!idUser) return { idFormatado: null, idUser: null };
      const idFormatado = idUser.substring(9);
      return { idFormatado, idUser };
    };

    const verificaLogin = () => {
      const { idUser } = getIdUserCookie();
      const isLogged = idUser ? true : false;
      if (!isLogged) {
        window.location.href = "/login";
        return false;
      }
      return isLogged;
    };

    const getLinkWhatsapp = (usuario, valor) => {
      const link = `
      https://api.whatsapp.com/send?phone=5581992129128&text=Solicitação%20de%20saque\n\r%20Pix:${usuario.chavePix}\n\r%20Email:${usuario.email}\n\r%20Nome:${usuario.nomeCompleto}\r\n%20Apelido:${usuario.apelido}\r\n%20Valor:${valor}%20
      `;
      return link;
    };

    const getUsuario = async () => {
      verificaLogin();
      const { idFormatado: id } = getIdUserCookie();
      const response = await api.get("/usuario/buscar/" + id);
      const _usuario = response.data.usuario;
      usuario = _usuario;
      return _usuario;
    };

    const showUsuario = async () => {
      const usuario = await getUsuario();
      username.innerHTML = "Bem-vindo, " + usuario.nomeCompleto + "!";
      saldo.innerHTML = "Seu saldo de créditos: " + usuario.creditos;
    };

    const getRespostas = async () => {
      const usuario = await getUsuario();
      console.log(usuario);
      return usuario;
    };

    const getRodada = async () => {
      const response = await api.get("/rodada/listarUltima");
      return response.data.rodada;
    };

    const showRespostas = async () => {
      const { Respostas: respostas } = await getRespostas();
      const rodada = await getRodada();
      console.log({ res: respostas, rod: rodada });

      tbodyTabelaPontuacao.innerHTML = "";

      const pontuacaoArray = respostas.map((resp) => {
        let pontuacaoFinal = 0;
        const pontuacao = {};

        for (let i = 1; i <= 10; i++) {
          const key = `jogo${i}`;
          const jogo = rodada[key];
          const resposta = resp[key];
          const acerto = resposta == jogo;
          pontuacaoFinal += acerto ? 1 : 0;
          pontuacao[key] = acerto
            ? {
                data: resp.criado,
                pontuacaoFinal,
                acerto,
                icon: '<i class="fas fa-check success"></i>',
              }
            : {
                data: resp.criado,
                pontuacaoFinal,
                acerto,
                icon: '<i class="fas fa-times error"></i>',
              };
        }
        return pontuacao;
      });

      pontuacaoArray.sort((a, b) => {
        if (a.jogo10.pontuacaoFinal > b.jogo10.pontuacaoFinal) return -1;
        if (a.jogo10.pontuacaoFinal < b.jogo10.pontuacaoFinal) return 1;
        return 0;
      });

      console.log({ pontuacaoArray });

      pontuacaoArray.forEach((resp, index) => {
        const data = new Date(resp.data).toLocaleString();
        const tr = document.createElement("tr");
        tr.innerHTML = `
    <td>${data}</td>
    <td>${resp.jogo1.icon}</td>
    <td>${resp.jogo2.icon}</td>
    <td>${resp.jogo3.icon}</td>
    <td>${resp.jogo4.icon}</td>
    <td>${resp.jogo5.icon}</td>
    <td>${resp.jogo6.icon}</td>
    <td>${resp.jogo7.icon}</td>
    <td>${resp.jogo8.icon}</td>
    <td>${resp.jogo9.icon}</td>
    <td>${resp.jogo10.icon}</td>
    <td>${resp.jogo10.pontuacaoFinal}</td>
    `;
        tbodyTabelaPontuacao.appendChild(tr);
      });
      $(document).ready(() => {
        $("#tabelaPontuacao").DataTable({
          responsive: true,
          fixedHeader: true,
          language: {
            url: "//cdn.datatables.net/plug-ins/1.10.25/i18n/Portuguese-Brasil.json",
          },
        });
      });
      // document.querySelector(".c-loader").classList.add("hide");
      // document.querySelector(".tabelaPontuacao").classList.remove("hide");
    };

    const main = async () => {
      const isLogged = verificaLogin();
      if (!isLogged) {
        window.location.href = "/login";
        return;
      }
      document.querySelector("body").classList.remove("hide");
      await Promise.all([showUsuario(), showRespostas()]);
    };
    main();
  </script>
</html>
